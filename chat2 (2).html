<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Crypto Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --bg-color: #0b0e11;
            --container-bg: #151921;
            --accent-color: #00a884; /* –¶–≤–µ—Ç –∫–∞–∫ –≤ WhatsApp */
            --text-color: #e9edef;
            --border-color: #30363d;
        }

        body { 
            background: var(--bg-color); 
            color: var(--text-color); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; 
            display: flex; 
            justify-content: center;
            height: 100vh;
        }

        .container { 
            width: 100%; 
            max-width: 500px; 
            background: var(--container-bg); 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #login-screen {
            padding: 40px 20px;
            justify-content: center;
            align-items: center;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
        }

        input { 
            width: 100%; 
            padding: 15px; 
            margin: 10px 0; 
            background: #20262d; 
            border: 1px solid var(--border-color); 
            color: white; 
            border-radius: 10px; 
            font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iPhone */
            outline: none;
        }

        input:focus { border-color: var(--accent-color); }

        button { 
            width: 100%; 
            padding: 15px; 
            background: var(--accent-color); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:active { opacity: 0.7; }

        /* –≠–ö–†–ê–ù –ß–ê–¢–ê */
        #chat-screen { 
            display: none; 
            flex-direction: column; 
            height: 100vh; 
        }

        .header {
            padding: 15px;
            background: #20262d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        #messages { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px;
        }

        .msg-item { 
            background: #20262d; 
            padding: 10px 15px; 
            border-radius: 10px; 
            max-width: 85%; 
            word-wrap: break-word;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .input-area {
            padding: 10px;
            background: #20262d;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #msgInput { margin: 0; flex-grow: 1; }
        .send-btn { width: auto; padding: 12px 20px; }
    </style>
</head>
<body>

<div id="login-screen">
    <h2 style="margin-bottom: 30px;">üîê Anon Chat</h2>
    <input type="text" id="userName" placeholder="–í–∞—à–µ –∏–º—è">
    <input type="password" id="seedPhrase" placeholder="–°–∏–¥-—Ñ—Ä–∞–∑–∞">
    <button onclick="enterChat()">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
</div>

<div id="chat-screen">
    <div class="header">
        <span id="display-name" style="font-weight: bold;"></span>
        <button onclick="loadMessages()" style="width:auto; padding: 5px 10px; font-size: 12px; background: #30363d;">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    
    <div id="messages"></div>

    <div class="input-area">
        <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
    </div>
</div>

<script>
    const GITHUB_TOKEN = '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'; 
    const GIST_ID = 'cbdc1fe127576153aed19a000637acbe';
    const FILE_NAME = 'chat.txt';

    let currentUser = '';
    let currentSeed = '';

    function enterChat() {
        currentUser = document.getElementById('userName').value.trim();
        currentSeed = document.getElementById('seedPhrase').value.trim();

        if (!currentUser || !currentSeed) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('display-name').innerText = currentUser;
        
        loadMessages();
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter
    document.getElementById('msgInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    async function loadMessages() {
        const msgDiv = document.getElementById('messages');
        try {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}?t=${Date.now()}`);
            const data = await response.json();
            const content = data.files[FILE_NAME].content;
            
            const lines = content.split('\n');
            msgDiv.innerHTML = '';

            lines.forEach(line => {
                if (!line.trim()) return;
                try {
                    const bytes = CryptoJS.AES.decrypt(line, currentSeed);
                    const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                    if (decrypted) {
                        msgDiv.innerHTML += `<div class="msg-item">${decrypted}</div>`;
                    }
                } catch (e) {}
            });
            msgDiv.scrollTop = msgDiv.scrollHeight;
        } catch (err) {
            msgDiv.innerHTML = '<center>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</center>';
        }
    }

    async function sendMessage() {
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if (!text) return;

        const fullMessage = `${currentUser}: ${text}`;
        const encrypted = CryptoJS.AES.encrypt(fullMessage, currentSeed).toString();

        input.value = ''; // –û—á–∏—â–∞–µ–º —Å—Ä–∞–∑—É –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞

        try {
            const getResp = await fetch(`https://api.github.com/gists/${GIST_ID}`);
            const getData = await getResp.json();
            const oldContent = getData.files[FILE_NAME].content;
            const newContent = oldContent + (oldContent ? '\n' : '') + encrypted;

            await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: { [FILE_NAME]: { content: newContent } }
                })
            });
            loadMessages();
        } catch (err) {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
        }
    }
</script>

</body>
</html>